# æ•™æ¡ˆ2ï¼šé¡¹ç›®æ¶æ„è®¾è®¡

> ç›®çš„ï¼šè®©å­¦ç”Ÿç†è§£ Agent æ˜¯æ€ä¹ˆè·¯ç”±çš„ï¼Œå‰åç«¯å¦‚ä½•åä½œ

---

## ä¸€ã€Agent æ¶æ„ï¼ˆæ ¸å¿ƒäº®ç‚¹ï¼‰

### è§£å†³æ–¹æ¡ˆï¼š4 å±‚å¤„ç†

```
ç”¨æˆ·è¾“å…¥ï¼ˆè‡ªç„¶è¯­è¨€ï¼‰
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬1å±‚ï¼šIntentAnalyzerï¼ˆæ„å›¾åˆ†æå™¨ï¼‰       â”‚
â”‚ "å¸®æˆ‘ç”»ä¸€åªçŒ«" â†’ contentType=IMAGE       â”‚
â”‚ ä½¿ç”¨ OneRouter gpt-4o-mini è§£æ          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬2å±‚ï¼šRoutingAgentï¼ˆè·¯ç”±å†³ç­–ï¼‰           â”‚
â”‚ IMAGE + é»˜è®¤å‚æ•° â†’ gemini-2.5-flash     â”‚
â”‚ å¦‚æœéœ€è¦4K â†’ gemini-3-pro-image         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬3å±‚ï¼šPromptEnhancerï¼ˆæç¤ºè¯å¢å¼ºï¼‰       â”‚
â”‚ "ä¸€åªçŒ«" â†’ "ä¸€åªçŒ«, high quality, detailed"â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬4å±‚ï¼šProviderRouter â†’ Providerï¼ˆæ‰§è¡Œï¼‰  â”‚
â”‚ æŒ‰ active-provider é…ç½®è·¯ç”±åˆ° Google      â”‚
â”‚ è°ƒç”¨ Gemini API ç”Ÿæˆå›¾ç‰‡                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡

1. **å…³æ³¨ç‚¹åˆ†ç¦»**ï¼šæ¯å±‚åªåšä¸€ä»¶äº‹ï¼ŒèŒè´£æ¸…æ™°
2. **å¯æ›¿æ¢æ€§**ï¼šæ¢ä¸€ä¸ªå›¾ç‰‡æ¨¡å‹ï¼Œåªéœ€å®ç° `ImageGenerationProvider` æ¥å£
3. **æˆæœ¬æ§åˆ¶**ï¼šæ„å›¾åˆ†æç”¨å»‰ä»· LLMï¼Œç”Ÿæˆæ‰ç”¨è´µçš„æ¨¡å‹
4. **å¯æ‰©å±•**ï¼šåŠ æ–°çš„å†…å®¹ç±»å‹åªéœ€æ–°å¢ Provider

---

## äºŒã€æ„å›¾åˆ†æ â†’ æ¨¡å‹é€‰æ‹© â†’ ä»»åŠ¡æ‰§è¡Œ æµç¨‹

### å®Œæ•´è¯·æ±‚é“¾è·¯

```
å‰ç«¯                        åç«¯
  â”‚                          â”‚
  â”‚ POST /api/aigc/generate  â”‚
  â”‚ { prompt: "ç”»ä¸€åªçŒ«" }    â”‚
  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>   â”‚
  â”‚                          â”‚
  â”‚                     AigcController.generate()
  â”‚                          â”‚
  â”‚                     AigcServiceImpl.generate()
  â”‚                          â”œâ”€ routingAgent.analyze(request)
  â”‚                          â”‚    â”œâ”€ intentAnalyzer.analyze()  â† è°ƒç”¨ OneRouter
  â”‚                          â”‚    â”œâ”€ selectOptimalModel()      â† æ¨¡å‹é€‰æ‹©
  â”‚                          â”‚    â””â”€ promptEnhancer.enhance()  â† æç¤ºè¯å¢å¼º
  â”‚                          â”‚
  â”‚                          â”œâ”€ åˆ›å»º AigcTask (PENDING)
  â”‚                          â”œâ”€ @Async executeGenerationAsync()  â† å¼‚æ­¥æ‰§è¡Œ
  â”‚                          â”‚
  â”‚ <â”€â”€â”€ { taskId, agentAnalysis }
  â”‚                          â”‚
  â”‚ GET /task/{id} (è½®è¯¢)     â”‚      å¼‚æ­¥çº¿ç¨‹:
  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>   â”‚      â”œâ”€ task.status = PROCESSING
  â”‚ <â”€â”€â”€ { status: PROCESSING }    â”œâ”€ routingAgent.executeGeneration()
  â”‚                          â”‚      â”‚    â””â”€ providerRouter.getImageProvider()
  â”‚ GET /task/{id} (è½®è¯¢)     â”‚      â”‚         â””â”€ GoogleImageProvider.generate()
  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>   â”‚      â”‚              â””â”€ è°ƒç”¨ Gemini API
  â”‚ <â”€â”€â”€ { status: PROCESSING }    â”‚
  â”‚                          â”‚      â”œâ”€ ä¿å­˜ AigcAsset
  â”‚ GET /task/{id} (è½®è¯¢)     â”‚      â””â”€ task.status = COMPLETED
  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>   â”‚
  â”‚ <â”€â”€â”€ { status: COMPLETED, result: { url: "..." } }
  â”‚                          â”‚
  â”‚ å±•ç¤ºç”Ÿæˆçš„å›¾ç‰‡              â”‚
```

### å…³é”®æ—¶é—´çº¿

| é˜¶æ®µ | è€—æ—¶ | è¯´æ˜ |
|------|------|------|
| æ„å›¾åˆ†æ | 1-3 ç§’ | OneRouter gpt-4o-mini è§£æ |
| å›¾ç‰‡ç”Ÿæˆ | 10-30 ç§’ | Gemini API è°ƒç”¨ |
| è§†é¢‘ç”Ÿæˆ | 1-5 åˆ†é’Ÿ | Veo predictLongRunning + è½®è¯¢ |
| TTS ç”Ÿæˆ | 5-15 ç§’ | Gemini TTS API |

---

## ä¸‰ã€Provider æŠ½è±¡è®¾è®¡

### æ¥å£ä½“ç³»

```
                ContentProvider (åŸºæ¥å£)
                â”œâ”€â”€ getProviderName()
                â”œâ”€â”€ isAvailable()
                â”œâ”€â”€ getProviderType()
                â”œâ”€â”€ generate(AigcTask)
                â””â”€â”€ generateAsync(AigcTask)
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“               â†“               â†“
ImageGeneration   VideoGeneration   AudioGeneration
   Provider          Provider          Provider
  + supportsI2I    + supportsI2V    + supportsTTS
  + supportsEdit   + supportsAudio  + supportsMusic
        â”‚               â”‚               â”‚
        â†“               â†“               â†“
  GoogleImage      GoogleVideo      GoogleAudio
   Provider          Provider         Provider
  (Gemini API)    (Veo API)        (TTS API)
```

### ä¸ºä»€ä¹ˆç”¨è¿™ç§è®¾è®¡

**å¼€é—­åŸåˆ™**ï¼šæ–°å¢æ¨¡å‹æä¾›å•†ï¼ˆæ¯”å¦‚ OpenAI DALL-Eï¼‰ï¼Œåªéœ€è¦ï¼š
1. å®ç° `ImageGenerationProvider` æ¥å£
2. åŠ ä¸Š `@Component` æ³¨è§£
3. åœ¨ `application-local.yml` é…ç½® `active-provider`

ä¸éœ€è¦æ”¹åŠ¨ä»»ä½•å·²æœ‰ä»£ç ã€‚ProviderRouter ä¼šé€šè¿‡ Spring ä¾èµ–æ³¨å…¥è‡ªåŠ¨å‘ç°æ–°çš„ Providerã€‚

### ProviderRouter è·¯ç”±é€»è¾‘

```java
// ProviderRouter çš„æ ¸å¿ƒé€»è¾‘ï¼š
// Spring è‡ªåŠ¨æ³¨å…¥æ‰€æœ‰ Provider å®ç°
private final List<ImageGenerationProvider> imageProviders;

// æ ¹æ®é…ç½®é€‰æ‹©æ¿€æ´»çš„ Provider
public ImageGenerationProvider getImageProvider() {
    String activeProvider = aigcProperties.getImage().getActiveProvider();
    return imageProviders.stream()
            .filter(p -> matchesProvider(p, activeProvider))  // åŒ¹é… "google"
            .filter(ContentProvider::isAvailable)              // æ£€æŸ¥å¯ç”¨æ€§
            .findFirst()
            .orElseThrow(...);
}
```

---

## å››ã€å‰åç«¯äº¤äº’æµç¨‹ï¼ˆè½®è¯¢æœºåˆ¶ï¼‰

### ä¸ºä»€ä¹ˆç”¨è½®è¯¢

AI å†…å®¹ç”Ÿæˆè€—æ—¶é•¿ï¼ˆå›¾ç‰‡ 10-30sï¼Œè§†é¢‘ 1-5minï¼‰ï¼Œä¸èƒ½åŒæ­¥ç­‰å¾…ã€‚

è§£å†³æ–¹æ¡ˆï¼š**å¼‚æ­¥ä»»åŠ¡ + å‰ç«¯è½®è¯¢**

### å‰ç«¯è½®è¯¢å®ç°

```typescript
// frontend/src/views/aigc/studio/index.vue
const pollTaskStatus = async (taskId: string) => {
  const maxAttempts = 180  // æœ€å¤šè½®è¯¢ 3 åˆ†é’Ÿ
  const interval = 1000    // æ¯ç§’è½®è¯¢ä¸€æ¬¡

  for (let i = 0; i < maxAttempts; i++) {
    const status = await fetchGetTaskStatus(taskId)

    if (status.status === 'COMPLETED' && status.result) {
      // ç”Ÿæˆå®Œæˆï¼Œå±•ç¤ºç»“æœ
      generationResult.value = { ... }
      return
    }

    if (status.status === 'FAILED') {
      ElMessage.error(status.errorMessage || 'åˆ›ä½œå¤±è´¥')
      return
    }

    await new Promise(resolve => setTimeout(resolve, interval))
  }
}
```

### åç«¯å¼‚æ­¥æ‰§è¡Œ

```java
// AigcServiceImpl.java
@Async  // Spring å¼‚æ­¥æ‰§è¡Œ
public void executeGenerationAsync(String taskId) {
    AigcTask task = taskRepository.findByTaskId(taskId).orElseThrow(...);

    task.setStatus(TaskStatus.PROCESSING);  // æ›´æ–°ä¸ºå¤„ç†ä¸­
    taskRepository.save(task);

    GenerationResult result = routingAgent.executeGeneration(task);

    if (result.isSuccess()) {
        // ä¿å­˜èµ„äº§ + æ›´æ–°çŠ¶æ€ä¸º COMPLETED
        AigcAsset asset = new AigcAsset();
        asset.setUrl(result.getUrl());
        assetRepository.save(asset);
        task.setStatus(TaskStatus.COMPLETED);
    } else {
        task.setStatus(TaskStatus.FAILED);
    }
    taskRepository.save(task);
}
```

### è§†é¢‘çš„åŒé‡è½®è¯¢

è§†é¢‘ç”Ÿæˆæœ‰ä¸¤å±‚è½®è¯¢ï¼š

```
å‰ç«¯è½®è¯¢                    åç«¯å†…éƒ¨è½®è¯¢
(1ç§’/æ¬¡, æœ€å¤š180æ¬¡)         (10ç§’/æ¬¡, æœ€å¤š30æ¬¡)
    â”‚                           â”‚
    â”œâ”€ GET /task/{id}           â”‚
    â”‚  â†’ PROCESSING             â”œâ”€ GET operation/{name}
    â”œâ”€ GET /task/{id}           â”‚  â†’ done: false
    â”‚  â†’ PROCESSING             â”œâ”€ sleep 10s
    â”œâ”€ ...                      â”œâ”€ GET operation/{name}
    â”‚                           â”‚  â†’ done: true âœ…
    â”‚                           â””â”€ ä¸‹è½½è§†é¢‘ â†’ ä¿å­˜æœ¬åœ°
    â”œâ”€ GET /task/{id}
    â”‚  â†’ COMPLETED âœ…
    â””â”€ å±•ç¤ºè§†é¢‘
```

---

## äº”ã€ç›®å½•ç»“æ„ï¼ˆç»“åˆä»£ç ï¼‰

### åç«¯ç›®å½•

```
backend/src/main/java/com/anjing/
â”œâ”€â”€ Application.java                      # å¯åŠ¨ç±» (@EnableAsync)
â”œâ”€â”€ aigc/
â”‚   â”œâ”€â”€ agent/                            # ğŸ§  æ™ºèƒ½è·¯ç”±æ ¸å¿ƒ
â”‚   â”‚   â”œâ”€â”€ IntentAnalyzer.java           # æ„å›¾åˆ†æå™¨ï¼ˆè°ƒç”¨ OneRouterï¼‰
â”‚   â”‚   â”œâ”€â”€ RoutingAgent.java             # è·¯ç”±Agentï¼ˆç¼–æ’+å†³ç­–ï¼‰
â”‚   â”‚   â””â”€â”€ PromptEnhancer.java           # æç¤ºè¯å¢å¼ºå™¨
â”‚   â”œâ”€â”€ controller/
â”‚   â”‚   â””â”€â”€ AigcController.java           # REST API å…¥å£
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”œâ”€â”€ AigcService.java              # æœåŠ¡æ¥å£
â”‚   â”‚   â””â”€â”€ impl/AigcServiceImpl.java     # æœåŠ¡å®ç°ï¼ˆå¼‚æ­¥ä»»åŠ¡è°ƒåº¦ï¼‰
â”‚   â”œâ”€â”€ provider/                         # ğŸ¨ å†…å®¹ç”Ÿæˆæä¾›å•†
â”‚   â”‚   â”œâ”€â”€ ContentProvider.java          # åŸºæ¥å£
â”‚   â”‚   â”œâ”€â”€ ImageGenerationProvider.java  # å›¾ç‰‡æ¥å£
â”‚   â”‚   â”œâ”€â”€ VideoGenerationProvider.java  # è§†é¢‘æ¥å£
â”‚   â”‚   â”œâ”€â”€ AudioGenerationProvider.java  # éŸ³é¢‘æ¥å£
â”‚   â”‚   â”œâ”€â”€ ProviderRouter.java           # æä¾›å•†è·¯ç”±å™¨
â”‚   â”‚   â””â”€â”€ google/                       # Google å®ç°
â”‚   â”‚       â”œâ”€â”€ GoogleImageProvider.java  # Gemini å›¾ç‰‡
â”‚   â”‚       â”œâ”€â”€ GoogleVideoProvider.java  # Veo è§†é¢‘
â”‚   â”‚       â””â”€â”€ GoogleAudioProvider.java  # TTS éŸ³é¢‘
â”‚   â”œâ”€â”€ model/                            # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ entity/                       # JPA å®ä½“
â”‚   â”‚   â”‚   â”œâ”€â”€ AigcTask.java             # ä»»åŠ¡è¡¨
â”‚   â”‚   â”‚   â””â”€â”€ AigcAsset.java            # èµ„äº§è¡¨
â”‚   â”‚   â”œâ”€â”€ dto/                          # ä¼ è¾“å¯¹è±¡
â”‚   â”‚   â”‚   â””â”€â”€ AnalyzedIntent.java       # æ„å›¾åˆ†æç»“æœ
â”‚   â”‚   â”œâ”€â”€ request/                      # è¯·æ±‚å¯¹è±¡
â”‚   â”‚   â”œâ”€â”€ response/                     # å“åº”å¯¹è±¡
â”‚   â”‚   â””â”€â”€ enums/                        # æšä¸¾
â”‚   â”‚       â”œâ”€â”€ ContentType.java          # IMAGE/VIDEO/AUDIO/TEXT
â”‚   â”‚       â””â”€â”€ TaskStatus.java           # PENDING/PROCESSING/COMPLETED/FAILED
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ AigcProperties.java           # AIGC é…ç½®å±æ€§ç±»
â”‚   â””â”€â”€ repository/                       # JPA ä»“å‚¨
â”‚       â”œâ”€â”€ AigcTaskRepository.java
â”‚       â””â”€â”€ AigcAssetRepository.java
â””â”€â”€ resources/
    â”œâ”€â”€ application.yml                   # ä¸»é…ç½®
    â””â”€â”€ application-local.yml             # æœ¬åœ°æ•æ„Ÿé…ç½®ï¼ˆAPI Keyï¼‰
```

### å‰ç«¯ç›®å½•

```
frontend/src/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ aigc.ts                           # AIGC API æ¥å£å®šä¹‰
â”‚   â””â”€â”€ model/aigcModel.ts                # TypeScript ç±»å‹å®šä¹‰
â”œâ”€â”€ views/aigc/
â”‚   â”œâ”€â”€ studio/                           # ğŸ¨ åˆ›ä½œå·¥ä½œå°
â”‚   â”‚   â”œâ”€â”€ index.vue                     # ä¸»é¡µé¢ï¼ˆè¾“å…¥+è½®è¯¢+å±•ç¤ºï¼‰
â”‚   â”‚   â””â”€â”€ components/
â”‚   â”‚       â”œâ”€â”€ CreationInput.vue         # æ–‡æœ¬è¾“å…¥ + æ–‡ä»¶ä¸Šä¼ 
â”‚   â”‚       â”œâ”€â”€ GenerationPreview.vue     # ç”Ÿæˆè¿›åº¦å’Œç»“æœå±•ç¤º
â”‚   â”‚       â””â”€â”€ HistoryPanel.vue          # å†å²è®°å½•
â”‚   â”œâ”€â”€ gallery/                          # ğŸŒŸ çµæ„Ÿå¹¿åœº
â”‚   â”‚   â”œâ”€â”€ index.vue
â”‚   â”‚   â””â”€â”€ components/
â”‚   â”‚       â””â”€â”€ PromptCard.vue            # æç¤ºè¯å¡ç‰‡
â”‚   â””â”€â”€ assets/                           # ğŸ“¦ æˆ‘çš„èµ„äº§
â”‚       â”œâ”€â”€ index.vue
â”‚       â””â”€â”€ components/
â”‚           â””â”€â”€ AssetCard.vue             # èµ„äº§å¡ç‰‡
â”œâ”€â”€ router/modules/aigc.ts                # è·¯ç”±é…ç½®
â””â”€â”€ utils/http/index.ts                   # Axios å°è£…
```

### å…³é”®é…ç½®æ–‡ä»¶

```yaml
# application-local.yml æ ¸å¿ƒç»“æ„
aigc:
  providers:
    google:           # Google API ç»Ÿä¸€é…ç½®
      api-key: xxx
      proxy-host: 127.0.0.1
      proxy-port: 7897
    onerouter:        # Agent LLM é…ç½®
      api-key: xxx
      model: gpt-4o-mini
  image:
    active-provider: google    # å›¾ç‰‡ç”¨ Google
    google:
      model: gemini-2.5-flash-image
  video:
    active-provider: google    # è§†é¢‘ç”¨ Google
    google:
      model: veo-3.1-fast-generate-preview
  audio:
    active-provider: google    # éŸ³é¢‘ç”¨ Google
    google:
      model: gemini-2.5-flash-preview-tts
```
