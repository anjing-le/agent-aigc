# 环境准备与运行指南

## 1. 环境要求

| 环境 | 要求 | 说明 |
|------|------|------|
| JDK | 17+ | 后端使用 Spring Boot 3.4.5 |
| Node.js | 20.19.0+ | 前端使用 Vite 7 + Vue 3 |
| pnpm | 8.8.0+ | 前端包管理器 |
| MySQL | 8.0+ | 数据库 |
| Redis | 6.0+ | 缓存 |
| Maven | 3.8+ | 后端依赖管理 |

## 2. API Key 配置

本项目需要两个 API Key：

### Google GenAI API Key
- 用途：图片生成（Gemini）、视频生成（Veo）、语音合成（TTS）
- 获取：[Google AI Studio](https://aistudio.google.com/apikey)
- 注意：需要科学上网（项目已内置代理配置）

### OneRouter API Key
- 用途：Agent 意图分析（调用 gpt-4o-mini）
- 获取：[OneRouter](https://onerouter.pro)
- 说明：用低成本 LLM 解析用户意图，避免直接消耗昂贵的 Google 模型

## 3. 后端启动

### 3.1 创建数据库

```sql
CREATE DATABASE agent_aigc DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
```

JPA 配置了 `ddl-auto: update`，表结构会自动创建。

### 3.2 修改配置

编辑 `backend/src/main/resources/application-local.yml`，填入你的 API Key：

```yaml
aigc:
  providers:
    google:
      enabled: true
      api-key: 你的Google_API_Key
      base-url: https://generativelanguage.googleapis.com
      proxy-host: 127.0.0.1    # 代理地址
      proxy-port: 7897          # 代理端口

    onerouter:
      enabled: true
      api-key: 你的OneRouter_API_Key
      api-url: https://llm.onerouter.pro/v1
      model: gpt-4o-mini
```

### 3.3 启动后端

```bash
cd backend
mvn spring-boot:run
```

启动成功后会看到：
```
✅ Google Image Provider (Nano Banana) 初始化成功
✅ Google Video Provider (Veo) 初始化成功
✅ Google Audio Provider (TTS) 初始化成功
```

后端运行在 `http://localhost:10003`

## 4. 前端启动

```bash
cd frontend
pnpm install
pnpm dev
```

前端运行后自动打开浏览器，Vite 已配置 `/api` 代理到 `http://localhost:10003`。

## 5. 验证方式

### 快速验证（API 直接调用）

```bash
# 测试意图分析 + 图片生成
curl -X POST http://localhost:10003/api/aigc/generate \
  -H "Content-Type: application/json" \
  -d '{"prompt": "帮我画一只在星空下跳舞的猫"}'
```

正常返回：
```json
{
  "code": 200,
  "data": {
    "taskId": "xxx",
    "status": "PENDING",
    "agentAnalysis": {
      "intent": "text_to_image",
      "contentType": "IMAGE",
      "selectedModel": "gemini-2.5-flash-image"
    }
  }
}
```

### 前端验证

1. 打开创作工作台页面
2. 输入"画一只猫在跳舞"
3. 观察 Agent 自动识别为图片生成、选择模型、优化提示词
4. 等待生成结果展示

## 6. 常见问题

| 问题 | 原因 | 解决方案 |
|------|------|---------|
| Google API 调用超时 | 网络问题 | 检查代理配置是否正确，`proxy-host` 和 `proxy-port` |
| OneRouter 调用失败 | API Key 无效或余额不足 | 检查 OneRouter 控制台余额和 Key 状态 |
| 数据库连接失败 | MySQL 未启动或密码不对 | 检查 `application-local.yml` 中的数据库配置 |
| 前端 API 404 | 后端未启动 | 确保后端在 10003 端口运行 |
| 视频生成超时 | Veo 生成较慢（1-5 分钟） | 属于正常现象，视频轮询间隔 10 秒，最多等 5 分钟 |
| Redis 连接失败 | Redis 未启动 | 启动本地 Redis 或在配置中修改地址 |
